<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copa Pistão</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/jogo.css">
</head>

<body>
    
    <div class="container">
        <div class="popup_end_game" style="display: none;" id="id_popup_end_game">
            <img src="assets/img/img_end_game.png" alt="">
            <p class="textoLarge fontPixelBlack ">Fim de jogo...</p>
            <p class="fontPixelBlack ">Parece que o caminho chegou ao fim... por agora!</p>
            <p class="fontPixelBlack ">Tente Novamente! A persistência leva à vitória.</p>
            <button onclick="irDashboard()" class="btn_voltar fontPixelBlack">Ir para a dashboard</button>
        </div>
        <div id="id_cont_jogo" class="cont_jogo">
            <h1 class="fontPixel">Copa Pistão</h1>
            <div class="div_cronometro_pontuacao">
                <p class="fontPixel" id="texto_cronometro"></p>
                <p class="fontPixel" id="texto_pontuacao"></p>
            </div>
            <div id="grid">
                <div class="posicao_line1 lines" id="line_1">
                    <div class="partesPista partesPistaEsquerdaCFaixa" id="partePista1"></div>
                    <div class="partesPista partesPistaMeioCFaixa" id="partePista2"></div>
                    <div class="partesPista partesPistaDireitaCFaixa" id="partePista3"></div>
                </div>
                <div class="posicao_line2 lines" id="line_2">
                    <div class="partesPista bordaEsquerda" id="partePista4"></div>
                    <div class="partesPista" id="partePista5"></div>
                    <div class="partesPista bordaDireita" id="partePista6"></div>
                </div>
                <div class="posicao_line3 lines" id="line_3">
                    <div class="partesPista partesPistaEsquerdaCFaixa" id="partePista7"></div>
                    <div class="partesPista partesPistaMeioCFaixa" id="partePista8"></div>
                    <div class="partesPista partesPistaDireitaCFaixa" id="partePista9"></div>
                </div>
                <div class="posicao_line4 lines" id="line_4">
                    <div class="partesPista bordaEsquerda" id="partePista10"></div>
                    <div class="partesPista" id="partePista11"></div>
                    <div class="partesPista bordaDireita" id="partePista12"></div>
                </div>
                <div class="posicao_line5 lines" id="line_5">
                    <div class="partesPista partesPistaEsquerdaCFaixa" id="partePista13"></div>
                    <div class="partesPista partesPistaMeioCFaixa" id="partePista14"></div>
                    <div class="partesPista partesPistaDireitaCFaixa" id="partePista15"></div>
                </div>
                <div class="posicao_line6 lines" id="line_6">
                    <div class="partesPista bordaEsquerda" id="partePista16"></div>
                    <div class="partesPista" id="partePista17"></div>
                    <div class="partesPista bordaDireita" id="partePista18"></div>
                </div>
                <div class="posicao_line7 lines" id="line_7">
                    <div class="partesPista partesPistaEsquerdaCFaixa" id="partePista19"></div>
                    <div class="partesPista partesPistaMeioCFaixa" id="partePista20"></div>
                    <div class="partesPista partesPistaDireitaCFaixa" id="partePista21"></div>
                </div>
                <div class="posicao_line8 lines" id="line_8">
                    <div class="partesPista bordaEsquerda" id="partePista22"></div>
                    <div class="partesPista" id="partePista23"></div>
                    <div class="partesPista bordaDireita" id="partePista24"></div>
                </div>

                <div class="linha_chegada lines" style="display: none;" id="linha_chegada">
                    <div class="partesPista partesPistaEsquerdaCFaixa" id="partePista22"></div>
                    <div class="partesPista partesPistaMeioCFaixa" id="partePista23"></div>
                    <div class="partesPista partesPistaDireitaCFaixa" id="partePista24"></div>
                </div>


                <div class="arredores" id="arredor1"></div>
                <div class="arredores" id="arredor2"></div>
                <div class="arredores" id="arredor3"></div>
                <div class="arredores" id="arredor4"></div>
                <div class="arredores" id="arredor5"></div>
                <div class="arredores" id="arredor6"></div>
                <div class="arredores" id="arredor7"></div>
                <div class="arredores" id="arredor8"></div>
                <div class="arredores" id="arredor9"></div>
                <div class="arredores" id="arredor10"></div>
                <div class="arredores" id="arredor11"></div>
                <div class="arredores" id="arredor12"></div>
                <div class="arredores" id="arredor13"></div>
                <div class="arredores" id="arredor14"></div>
                <div class="arredores" id="arredor15"></div>
                <div class="arredores" id="arredor16"></div>
                <img name="1" id="cacto" src="assets/img/img_cacto.jpg" alt="">
                <img name="2" id="img_bola_feno" src="assets/img/img_bola_de_feno.png" alt="">
                <img name="2" id="img_barril" src="assets/img/img_barril.png" alt="">
                <div id="cont_carro"></div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
   

    var urlParametros = window.location
    var idParametro = urlParametros.search.replace('?id=', '')
    var container_personagem = document.getElementById('container_personagem')
    var competidor = {}
    console.log(urlParametros);
    console.log(`ID do competidor: ${idParametro}`);
    fetch('json/competidores.json')
        .then(response => response.json())
        .then(competidores => {
            for (var i = 0; i < competidores.length; i++) {
                var competidorAtual = competidores[i];
                if (competidorAtual.id == idParametro) {
                    competidor = competidorAtual
                    console.log(competidorAtual);
                }
            }
            if (competidor != undefined) {
                cont_carro.innerHTML = `
                    <img src="${competidor.imagem}" alt="">
                `
            }
        })



    var colunaCarro = 3
    var linhaCarro = 6

    var obstaculo = [
        document.getElementById('cacto'),
        document.getElementById('img_bola_feno'),
        document.getElementById('img_barril')
    ]


    document.getElementById('cont_carro').style.gridRow = linhaCarro
    document.getElementById('cont_carro').style.gridColumn = colunaCarro;

    var colunaObstaculo = 0
    var linhaObstaculo = 0
    var colunaAleatoria = 0
    var contagemLinhas = 0
    var linhaAtual = 0
    var trocaDeLinha = 1
    var pontuacao = 0
    var intervaloChamada = 1090
    var timeOutColisao = 0

    setTimeout(() => {
        chamarObstaculo()
        movimentoPista()
    }, intervaloChamada);

    // FUNÇÃO QUE CHAMA O OBSTÁCULO VERIFICANDO A LINHA 
    function chamarObstaculo() {
        if (linhaAtual == 0) {
            if (contagemLinhas > 0) {
                obstaculo[indiceObstaculo].style.display = 'none'
            }
            sortearObstaculo()
        } else {
            mudarLinhaObstaculo(indiceObstaculo, colunaAleatoria)
        }
        timeOutColisao = setTimeout(verificarColisao, 1)
        console.log('Intervalo no chamar obstaculo:', intervaloChamada);

        timeOutGeral = setTimeout(() => {
            chamarObstaculo()
            movimentoPista()
        }, intervaloChamada);
    }
    function chamarChegada() {
    }

    function sortearObstaculo() {
        indiceObstaculo = Math.floor(Math.random() * 3)
        sortearColuna()
    }
    // FUNÇÃO QUE GERA UMA COLUNA ALEATÓRIA PARA O OBSTÁCULO
    function sortearColuna() {
        colunaAleatoria = Math.floor(Math.random() * 3) + 2
        colunaObstaculo = colunaAleatoria
        mudarLinhaObstaculo(indiceObstaculo, colunaAleatoria)
    }

    function mudarLinhaObstaculo(indiceObstaculo, colunaAleatoria) {
        timeOutColisao = setTimeout(verificarColisao, 1)
        obstaculo[indiceObstaculo].style.gridColumn = colunaAleatoria
        linhaAtual++
        linhaObstaculo = linhaAtual

        pontuacao += 5
        texto_pontuacao.innerHTML = `Pontuação: ${pontuacao}`

        if (linhaAtual < 8) {
            obstaculo[indiceObstaculo].style.gridRow = linhaAtual
            contagemLinhas++
        } else {
            obstaculo[indiceObstaculo].style.gridRow = linhaAtual
            linhaAtual = 0
            contagemLinhas++
        }

        // CONTROLADOR DE VELOCIDADE
        if (contagemLinhas >= 0 && contagemLinhas <= 100) {
            intervaloChamada -= 10
        } else if (contagemLinhas > 100 && contagemLinhas < 500) {
            intervaloChamada = 90
        } else {
            intervaloChamada -= 0.5
        }
        console.log('Intervalo no Mudar obstaculo:', intervaloChamada);
        obstaculo[indiceObstaculo].style.display = 'flex'
        timeOutColisao = setTimeout(verificarColisao, 1)
        console.log(contagemLinhas);

    }
    var redirecionadorBarril = 0
    var colisaoCacto = 0
    var colisaoFeno = 0
    var colisaoBarril = 0

    var auxiliarDashboard = 0

    function verificarColisao() {
        if (indiceObstaculo == 0 && linhaCarro == linhaObstaculo && colunaCarro == colunaObstaculo) {
            clearTimeout(timeOutColisao)
            clearTimeout(timeOutGeral)
            clearInterval(intervalCronometro)

            if (auxiliarDashboard == 0) {
                setTimeout(chamarPopUpEndGame, 1500)
                auxiliarDashboard++
            }


        } else if (indiceObstaculo == 1 && linhaCarro == linhaObstaculo && colunaCarro == colunaObstaculo) {
            colisaoFeno++
            contagemLinhas = 0
            intervaloChamada = 1090
            pontuacao -= 10
        } else if (indiceObstaculo == 2 && linhaCarro == linhaObstaculo && colunaCarro == colunaObstaculo) {
            colisaoBarril++
            pontuacao -= 5
            if (colunaCarro == 2) {
                colunaCarro = 3
            } else if (colunaCarro == 3) {
                if (redirecionadorBarril == 0) {
                    redirecionadorBarril = 1
                    colunaCarro = 2
                } else {
                    redirecionadorBarril = 0
                    colunaCarro = 4

                }
            } else if (colunaCarro == 4) {
                colunaCarro = 3
            }
            console.log('Indice no verificar:', intervaloChamada);
            document.getElementById('cont_carro').style.gridColumn = colunaCarro
        }
    }
    function movimentoPista() {
        if (trocaDeLinha == 0) {
            document.getElementById('line_1').classList.remove('posicao_line2')
            document.getElementById('line_2').classList.remove('posicao_line1')
            document.getElementById('line_3').classList.remove('posicao_line4')
            document.getElementById('line_4').classList.remove('posicao_line3')
            document.getElementById('line_5').classList.remove('posicao_line6')
            document.getElementById('line_6').classList.remove('posicao_line5')
            document.getElementById('line_7').classList.remove('posicao_line8')
            document.getElementById('line_8').classList.remove('posicao_line7')

            document.getElementById('line_1').classList.add('posicao_line1')
            document.getElementById('line_2').classList.add('posicao_line2')
            document.getElementById('line_3').classList.add('posicao_line3')
            document.getElementById('line_4').classList.add('posicao_line4')
            document.getElementById('line_5').classList.add('posicao_line5')
            document.getElementById('line_6').classList.add('posicao_line6')
            document.getElementById('line_7').classList.add('posicao_line7')
            document.getElementById('line_8').classList.add('posicao_line8')
            trocaDeLinha = 1
        } else {
            trocaDeLinha = 0
            document.getElementById('line_1').classList.remove('posicao_line1')
            document.getElementById('line_2').classList.remove('posicao_line2')
            document.getElementById('line_3').classList.remove('posicao_line3')
            document.getElementById('line_4').classList.remove('posicao_line4')
            document.getElementById('line_5').classList.remove('posicao_line5')
            document.getElementById('line_6').classList.remove('posicao_line6')
            document.getElementById('line_7').classList.remove('posicao_line7')
            document.getElementById('line_8').classList.remove('posicao_line8')

            document.getElementById('line_1').classList.add('posicao_line2')
            document.getElementById('line_2').classList.add('posicao_line1')
            document.getElementById('line_3').classList.add('posicao_line4')
            document.getElementById('line_4').classList.add('posicao_line3')
            document.getElementById('line_5').classList.add('posicao_line6')
            document.getElementById('line_6').classList.add('posicao_line5')
            document.getElementById('line_7').classList.add('posicao_line8')
            document.getElementById('line_8').classList.add('posicao_line7')
        }
        console.log('Intervalo no movimento pista:', intervaloChamada);

    }

    var tempo = 0
    var segundo = 0
    var minuto = 0
    function mudarCronometro() {
        var elemento_cronometro = document.getElementById('texto_cronometro')

        segundo++
        if (segundo >= 60) {
            segundo = 0
            minuto++
        }
        if (segundo <= 9) {
            tempo = `0${minuto}:0${segundo}`
            elemento_cronometro.innerHTML = tempo
        } else if (minuto <= 9) {
            tempo = `0${minuto}:${segundo}`
            elemento_cronometro.innerHTML = tempo
        } else {
            tempo = `${minuto}:${segundo}`
            elemento_cronometro.innerHTML = tempo
        }
    }
    var intervalCronometro = setInterval(() => {
        mudarCronometro()
    }, 1000);

    document.addEventListener('keydown', function (event) {
        if (event.key == 'ArrowLeft') {
            if (document.getElementById('cont_carro').style.gridColumn == 3) {
                colunaCarro = 2
                document.getElementById('cont_carro').style.gridColumn = colunaCarro

            } else if (document.getElementById('cont_carro').style.gridColumn == 4) {
                colunaCarro = 3
                document.getElementById('cont_carro').style.gridColumn = colunaCarro

            } else {
                console.log("Cai no else do left");
            }
            timeOutColisao = setTimeout(verificarColisao, 1)
        }
        if (event.key == 'ArrowRight') {
            if (document.getElementById('cont_carro').style.gridColumn == 3) {
                colunaCarro = 4
                document.getElementById('cont_carro').style.gridColumn = colunaCarro

            } else if (document.getElementById('cont_carro').style.gridColumn == 2) {
                colunaCarro = 3
                document.getElementById('cont_carro').style.gridColumn = colunaCarro

            } else {
                console.log("Cai no else do right");
            }
            timeOutColisao = setTimeout(verificarColisao, 1)
        }
    })

    function chamarPopUpEndGame() {
        id_popup_end_game.style.display = 'flex'
        id_cont_jogo.style.display = 'none'
    }
    function irDashboard() {

        sessionStorage.HABILITAR_DASHBOARD = 1

        console.log("Teste session: ", usuarioVar);

        var usuarioVar = sessionStorage.ID_USUARIO

        var corredorVar = competidor.id
        var tempoVar = `00:${tempo}`
        var pontuacaoVar = pontuacao
        var colisaoCactoVar = 1
        var colisaoFenoVar = colisaoFeno / 3
        var colisaoBarrilVar = colisaoBarril
        var pistaVar = 0
        var resultadoVar = 0
        var tempoFormatado = tempoVar.replaceAll(':', '')

        if (tempoFormatado > 300) {
            resultadoVar = 1
        }
        fetch("/jogo/registrar_dados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                usuarioServer: usuarioVar,
                corredorServer: corredorVar,
                tempoServer: tempoVar,
                pontuacaoServer: pontuacaoVar,
                colisaoCactoServer: colisaoCactoVar,
                colisaoFenoServer: colisaoFenoVar,
                colisaoBarrilServer: colisaoBarrilVar,
                resultadoServer: resultadoVar
            }),
        })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO irDash()!")
                console.log(resposta);
                if (resposta.ok) {
                    window.location = `dashboard.html?id=${sessionStorage.ID_USUARIO}`;
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (resposta) {
                console.log(resposta);

                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }
</script>